# React Hooks

## useState

### useState(initialState)

**å‚æ•°**

`initialState`ï¼šä½ å¸Œæœ› state åˆå§‹åŒ–çš„å€¼ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å€¼ï¼Œä½†å¯¹äºå‡½æ•°æœ‰ç‰¹æ®Šçš„è¡Œä¸ºã€‚åœ¨åˆå§‹æ¸²æŸ“åï¼Œæ­¤å‚æ•°å°†è¢«å¿½ç•¥ã€‚å¦‚æœä¼ é€’å‡½æ•°ä½œä¸º `initialState`ï¼Œåˆ™å®ƒå°†è¢«è§†ä¸º **åˆå§‹åŒ–å‡½æ•°**ã€‚å®ƒåº”è¯¥æ˜¯çº¯å‡½æ•°ï¼Œä¸åº”è¯¥æ¥å—ä»»ä½•å‚æ•°ï¼Œå¹¶ä¸”åº”è¯¥è¿”å›ä¸€ä¸ªä»»ä½•ç±»å‹çš„å€¼ã€‚å½“åˆå§‹åŒ–ç»„ä»¶æ—¶ï¼ŒReact å°†è°ƒç”¨ä½ çš„åˆå§‹åŒ–å‡½æ•°ï¼Œå¹¶å°†å…¶è¿”å›å€¼å­˜å‚¨ä¸ºåˆå§‹çŠ¶æ€ã€‚

**è¿”å›**

1. å½“å‰çš„ stateã€‚åœ¨é¦–æ¬¡æ¸²æŸ“æ—¶ï¼Œå®ƒå°†ä¸ä½ ä¼ é€’çš„ `initialState` ç›¸åŒ¹é…ã€‚
2. set å‡½æ•°ï¼Œå®ƒå¯ä»¥è®©ä½ å°† state æ›´æ–°ä¸ºä¸åŒçš„å€¼å¹¶è§¦å‘é‡æ–°æ¸²æŸ“ã€‚

### set å‡½æ•°ï¼Œä¾‹å¦‚ setSomething(nextState)

**å‚æ•°**

`nextState`ï¼šä½ æƒ³è¦ state æ›´æ–°ä¸ºçš„å€¼ã€‚å®ƒå¯ä»¥æ˜¯ä»»ä½•ç±»å‹çš„å€¼ï¼Œä½†å¯¹äºå‡½æ•°æœ‰ç‰¹æ®Šçš„è¡Œä¸ºã€‚å¦‚æœä½ å°†å‡½æ•°ä½œä¸º `nextState` ä¼ é€’ï¼Œå®ƒå°†è¢«è§†ä¸º **æ›´æ–°å‡½æ•°**ã€‚å®ƒå¿…é¡»æ˜¯çº¯å‡½æ•°ï¼Œåªæ¥å—å¾…å®šçš„ state ä½œä¸ºå…¶å”¯ä¸€å‚æ•°ï¼Œå¹¶åº”è¿”å›ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚React å°†æŠŠä½ çš„æ›´æ–°å‡½æ•°æ”¾å…¥é˜Ÿåˆ—ä¸­å¹¶é‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚åœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æœŸé—´ï¼ŒReact å°†é€šè¿‡æŠŠé˜Ÿåˆ—ä¸­æ‰€æœ‰æ›´æ–°å‡½æ•°åº”ç”¨äºå…ˆå‰çš„çŠ¶æ€æ¥è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€ã€‚

**è¿”å›**

set å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚

**æ³¨æ„äº‹é¡¹**

- `useState` æ˜¯ä¸€ä¸ª Hookï¼Œå› æ­¤ä½ åªèƒ½åœ¨ **ç»„ä»¶çš„é¡¶å±‚** æˆ–è‡ªå·±çš„ Hook ä¸­è°ƒç”¨å®ƒã€‚ä½ ä¸èƒ½åœ¨å¾ªç¯æˆ–æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨å®ƒã€‚å¦‚æœä½ éœ€è¦è¿™æ ·åšï¼Œè¯·æå–ä¸€ä¸ªæ–°ç»„ä»¶å¹¶å°†çŠ¶æ€ç§»å…¥å…¶ä¸­ã€‚
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸­ï¼ŒReact å°† **ä¸¤æ¬¡è°ƒç”¨åˆå§‹åŒ–å‡½æ•°**ï¼Œä»¥ [å¸®ä½ æ‰¾åˆ°æ„å¤–çš„ä¸çº¯æ€§](https://zh-hans.react.dev/reference/react/useState#my-initializer-or-updater-function-runs-twice)ã€‚è¿™åªæ˜¯å¼€å‘æ—¶çš„è¡Œä¸ºï¼Œä¸å½±å“ç”Ÿäº§ã€‚å¦‚æœä½ çš„åˆå§‹åŒ–å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼ˆæœ¬è¯¥æ˜¯è¿™æ ·ï¼‰ï¼Œå°±ä¸åº”å½±å“è¯¥è¡Œä¸ºã€‚å…¶ä¸­ä¸€ä¸ªè°ƒç”¨çš„ç»“æœå°†è¢«å¿½ç•¥ã€‚
- `set` å‡½æ•° **ä»…æ›´æ–° *ä¸‹ä¸€æ¬¡* æ¸²æŸ“çš„çŠ¶æ€å˜é‡**ã€‚å¦‚æœåœ¨è°ƒç”¨ `set` å‡½æ•°åè¯»å–çŠ¶æ€å˜é‡ï¼Œåˆ™ [ä»ä¼šå¾—åˆ°åœ¨è°ƒç”¨ä¹‹å‰æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„æ—§å€¼](https://zh-hans.react.dev/reference/react/useState#ive-updated-the-state-but-logging-gives-me-the-old-value)ã€‚
- å¦‚æœä½ æä¾›çš„æ–°å€¼ä¸å½“å‰ `state` ç›¸åŒï¼ˆç”± [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¯”è¾ƒç¡®å®šï¼‰ï¼ŒReact å°† **è·³è¿‡é‡æ–°æ¸²æŸ“è¯¥ç»„ä»¶åŠå…¶å­ç»„ä»¶**ã€‚è¿™æ˜¯ä¸€ç§ä¼˜åŒ–ã€‚è™½ç„¶åœ¨æŸäº›æƒ…å†µä¸‹ React ä»ç„¶éœ€è¦åœ¨è·³è¿‡å­ç»„ä»¶ä¹‹å‰è°ƒç”¨ä½ çš„ç»„ä»¶ï¼Œä½†è¿™ä¸åº”å½±å“ä½ çš„ä»£ç ã€‚
- React ä¼š [æ‰¹é‡å¤„ç†çŠ¶æ€æ›´æ–°](https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates)ã€‚å®ƒä¼šåœ¨æ‰€æœ‰ **äº‹ä»¶å¤„ç†å‡½æ•°è¿è¡Œ** å¹¶è°ƒç”¨å…¶ `set` å‡½æ•°åæ›´æ–°å±å¹•ã€‚è¿™å¯ä»¥é˜²æ­¢åœ¨å•ä¸ªäº‹ä»¶æœŸé—´å¤šæ¬¡é‡æ–°æ¸²æŸ“ã€‚åœ¨æŸäº›ç½•è§æƒ…å†µä¸‹ï¼Œä½ éœ€è¦å¼ºåˆ¶ React æ›´æ—©åœ°æ›´æ–°å±å¹•ï¼Œä¾‹å¦‚è®¿é—® DOMï¼Œä½ å¯ä»¥ä½¿ç”¨ [`flushSync`](https://zh-hans.react.dev/reference/react-dom/flushSync)ã€‚
- åœ¨æ¸²æŸ“æœŸé—´ï¼Œåªå…è®¸åœ¨å½“å‰æ¸²æŸ“ç»„ä»¶å†…éƒ¨è°ƒç”¨ `set` å‡½æ•°ã€‚React å°†ä¸¢å¼ƒå…¶è¾“å‡ºå¹¶ç«‹å³å°è¯•ä½¿ç”¨æ–°çŠ¶æ€é‡æ–°æ¸²æŸ“ã€‚è¿™ç§æ–¹å¼å¾ˆå°‘éœ€è¦ï¼Œä½†ä½ å¯ä»¥ä½¿ç”¨å®ƒæ¥å­˜å‚¨ **å…ˆå‰æ¸²æŸ“ä¸­çš„ä¿¡æ¯**ã€‚[è¯·å‚è§ä¸‹é¢çš„ç¤ºä¾‹](https://zh-hans.react.dev/reference/react/useState#storing-information-from-previous-renders)ã€‚
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸­ï¼ŒReact å°† **ä¸¤æ¬¡è°ƒç”¨ä½ çš„æ›´æ–°å‡½æ•°**ï¼Œä»¥å¸®åŠ©ä½ æ‰¾åˆ° [æ„å¤–çš„ä¸çº¯æ€§](https://zh-hans.react.dev/reference/react/useState#my-initializer-or-updater-function-runs-twice)ã€‚è¿™åªæ˜¯å¼€å‘æ—¶çš„è¡Œä¸ºï¼Œä¸å½±å“ç”Ÿäº§ã€‚å¦‚æœä½ çš„æ›´æ–°å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼ˆæœ¬è¯¥æ˜¯è¿™æ ·ï¼‰ï¼Œå°±ä¸åº”å½±å“è¯¥è¡Œä¸ºã€‚å…¶ä¸­ä¸€æ¬¡è°ƒç”¨çš„ç»“æœå°†è¢«å¿½ç•¥ã€‚

### ç”¨æ³•

#### æ ¹æ®å…ˆå‰çš„ state æ›´æ–° state

å‡è®¾ age ä¸º 42ï¼Œæƒ³è¦ç‚¹å‡»ä¸€æ¬¡æ›´æ–°ä¸‰ä¸ªçŠ¶æ€ï¼Œè¯·ç»™ set å‡½æ•°ä¼ å…¥æ›´æ–°å‡½æ•°ï¼Œè€Œä¸æ˜¯ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼š

```javascript
function handleClick() {
	// setAge(age + 1); // setAge(42 + 1)
	// setAge(age + 1); // setAge(42 + 1)
	// setAge(age + 1); // setAge(42 + 1)
	setAge(a => a + 1); // setAge(42 => 43)
	setAge(a => a + 1); // setAge(43 => 44)
	setAge(a => a + 1); // setAge(44 => 45)
}
```

#### æ›´æ–°çŠ¶æ€ä¸­çš„å¯¹è±¡å’Œæ•°ç»„

åœ¨ React ä¸­ï¼Œstate è¢«è®¤ä¸ºæ˜¯åªè¯»çš„ï¼Œå› æ­¤åº”è¯¥æ›¿æ¢å®ƒè€Œä¸æ˜¯æ”¹å˜ç°æœ‰å¯¹è±¡ã€‚æ¯”å¦‚ç›´æ¥é‡ç½®å¯¹è±¡çš„æŸä¸ªå±æ€§å€¼ã€‚

å¯¹äº React state ä¸­çš„å¯¹è±¡ï¼Œå½“å¯¹è±¡çš„å±‚æ¬¡æ¯”è¾ƒå°‘æ—¶ï¼Œå¯ä»¥ä½¿ç”¨æ‰©å±•è¿ç®—ç¬¦æ¥åˆ›å»ºæ–°å¯¹è±¡ï¼›å½“å¯¹è±¡çš„å±‚æ¬¡æ¯”è¾ƒå¤šæ—¶ï¼Œå¯ä»¥ä½¿ç”¨ **Immer**ï¼ŒImmer çš„åº•å±‚ä½¿ç”¨äº† Proxyã€‚

å¯¹äº React state ä¸­çš„æ•°ç»„ï¼Œéœ€è¦é¿å…ä½¿ç”¨å·¦åˆ—çš„æ–¹æ³•ï¼Œè€Œé¦–é€‰å³åˆ—çš„æ–¹æ³•ï¼š

|          | é¿å…ä½¿ç”¨ (ä¼šæ”¹å˜åŸå§‹æ•°ç»„)     | æ¨èä½¿ç”¨ (ä¼šè¿”å›ä¸€ä¸ªæ–°æ•°ç»„ï¼‰  |
| -------- | ----------------------------- | ----------------------------- |
| æ·»åŠ å…ƒç´  | `push`ï¼Œ`unshift`             | `concat`ï¼Œ`[...arr]` å±•å¼€è¯­æ³• |
| åˆ é™¤å…ƒç´  | `pop`ï¼Œ`shift`ï¼Œ`splice`      | `filter`ï¼Œ`slice`             |
| æ›¿æ¢å…ƒç´  | `splice`ï¼Œ`arr[i] = ...` èµ‹å€¼ | `map`                         |
| æ’åº     | `reverse`ï¼Œ`sort`             | å…ˆå°†æ•°ç»„å¤åˆ¶ä¸€ä»½              |

æˆ–è€…ï¼Œä½¿ç”¨ **Immer**ã€‚

è¿˜æœ‰ä¸€ä¸ªå€¼å¾—æ³¨æ„çš„ç‚¹æ˜¯ï¼Œå½“å¯¹è±¡æ˜¯å¤šå±‚çº§çš„ï¼Œæˆ–è€…æ•°ç»„ä¸­æœ‰ä¸‹ä¸€å±‚çº§çš„æ•°ç»„æˆ–å¯¹è±¡ï¼Œåº”å½“æ³¨æ„æ‰©å±•è¿ç®—ç¬¦æ˜¯æµ…æ‹·è´çš„ï¼Œä¹Ÿè®¸ç¬¬ä¸€å±‚é€šè¿‡æ‰©å±•è¿ç®—ç¬¦è¿›è¡Œæ‹·è´å·²ç»æ”¹å˜äº†å¼•ç”¨ï¼Œä½†ä»–ä»¬çš„å­å…ƒç´ ä»ç„¶è¿˜æœ‰åŒæ ·çš„å¼•ç”¨ï¼š

```javascript
const a = [{name: 1, val: 1}, {name: 2, val: 2}, {name: 3, val: 3}]
const b = [...a]
b[0].name = 4 // b [{name: 4, val: 1}, {name: 2, val: 2}, {name: 3, val: 3}]
a // [{name: 4, val: 1}, {name: 2, val: 2}, {name: 3, val: 3}]
a === b // false
```

å¦‚æœä¸æƒ³è‡ªå·±é€’å½’å»æŸ¥è¯¢å¹¶ä¸”ä¿®æ”¹æŸä¸ªå€¼ï¼Œè¯·ä½¿ç”¨ **Immer** ç¼–å†™æ›´ç®€æ´çš„ä»£ç ã€‚

#### é¿å…é‡å¤åˆ›å»ºåˆå§‹çŠ¶æ€

ä½¿ç”¨ useState è®¾ç½®åˆå§‹æ•°æ®æ—¶ï¼Œå°½é‡ä¼ å…¥ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°ï¼Œè€Œä¸æ˜¯åˆå§‹åŒ–å‡½æ•°ç”Ÿæˆæ•°æ®çš„æ‰§è¡Œç»“æœï¼š`useState(func()) => useState(func)`ã€‚



## useEffect

### useEffect(setup, dependencies?)

**å‚æ•°**

`setup`ï¼šå¤„ç† Effect çš„å‡½æ•°ã€‚setup å‡½æ•°é€‰æ‹©æ€§è¿”å›ä¸€ä¸ª **æ¸…ç†ï¼ˆcleanupï¼‰** å‡½æ•°ã€‚å½“ç»„ä»¶è¢«æ·»åŠ åˆ° DOM çš„æ—¶å€™ï¼ŒReact å°†è¿è¡Œ setup å‡½æ•°ã€‚åœ¨æ¯æ¬¡ä¾èµ–é¡¹å˜æ›´é‡æ–°æ¸²æŸ“åï¼ŒReact å°†é¦–å…ˆä½¿ç”¨æ—§å€¼è¿è¡Œ cleanup å‡½æ•°ï¼ˆå¦‚æœä½ æä¾›äº†è¯¥å‡½æ•°ï¼‰ï¼Œç„¶åä½¿ç”¨æ–°å€¼è¿è¡Œ setup å‡½æ•°ã€‚åœ¨ç»„ä»¶ä» DOM ä¸­ç§»é™¤åï¼ŒReact å°†æœ€åä¸€æ¬¡è¿è¡Œ cleanup å‡½æ•°ã€‚

**å¯é€‰** `dependencies`ï¼š`setup` ä»£ç ä¸­å¼•ç”¨çš„æ‰€æœ‰å“åº”å¼å€¼çš„åˆ—è¡¨ã€‚å“åº”å¼å€¼åŒ…æ‹¬ propsã€state ä»¥åŠæ‰€æœ‰ç›´æ¥åœ¨ç»„ä»¶å†…éƒ¨å£°æ˜çš„å˜é‡å’Œå‡½æ•°ã€‚å¦‚æœä½ çš„ä»£ç æ£€æŸ¥å·¥å…· [é…ç½®äº† React](https://zh-hans.react.dev/learn/editor-setup#linting)ï¼Œé‚£ä¹ˆå®ƒå°†éªŒè¯æ˜¯å¦æ¯ä¸ªå“åº”å¼å€¼éƒ½è¢«æ­£ç¡®åœ°æŒ‡å®šä¸ºä¸€ä¸ªä¾èµ–é¡¹ã€‚ä¾èµ–é¡¹åˆ—è¡¨çš„å…ƒç´ æ•°é‡å¿…é¡»æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”å¿…é¡»åƒ `[dep1, dep2, dep3]` è¿™æ ·å†…è”ç¼–å†™ã€‚React å°†ä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¥æ¯”è¾ƒæ¯ä¸ªä¾èµ–é¡¹å’Œå®ƒå…ˆå‰çš„å€¼ã€‚å¦‚æœçœç•¥æ­¤å‚æ•°ï¼Œåˆ™åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ç»„ä»¶ä¹‹åï¼Œå°†é‡æ–°è¿è¡Œ Effect å‡½æ•°ã€‚

**è¿”å›**

useEffect è¿”å› undefinedã€‚

**æ³¨æ„äº‹é¡¹**

- `useEffect` æ˜¯ä¸€ä¸ª Hookï¼Œå› æ­¤åªèƒ½åœ¨ **ç»„ä»¶çš„é¡¶å±‚** æˆ–è‡ªå·±çš„ Hook ä¸­è°ƒç”¨å®ƒï¼Œè€Œä¸èƒ½åœ¨å¾ªç¯æˆ–è€…æ¡ä»¶å†…éƒ¨è°ƒç”¨ã€‚å¦‚æœéœ€è¦ï¼ŒæŠ½ç¦»å‡ºä¸€ä¸ªæ–°ç»„ä»¶å¹¶å°† state ç§»å…¥å…¶ä¸­ã€‚
- å¦‚æœä½  **æ²¡æœ‰æ‰“ç®—ä¸æŸä¸ªå¤–éƒ¨ç³»ç»ŸåŒæ­¥**ï¼Œ[é‚£ä¹ˆä½ å¯èƒ½ä¸éœ€è¦ Effect](https://zh-hans.react.dev/learn/you-might-not-need-an-effect)ã€‚
- å½“ä¸¥æ ¼æ¨¡å¼å¯åŠ¨æ—¶ï¼ŒReact å°†åœ¨çœŸæ­£çš„ setup å‡½æ•°é¦–æ¬¡è¿è¡Œå‰ï¼Œ**è¿è¡Œä¸€ä¸ªå¼€å‘æ¨¡å¼ä¸‹ä¸“æœ‰çš„é¢å¤– setup + cleanup å‘¨æœŸ**ã€‚è¿™æ˜¯ä¸€ä¸ªå‹åŠ›æµ‹è¯•ï¼Œç”¨äºç¡®ä¿ cleanup é€»è¾‘â€œæ˜ å°„â€åˆ°äº† setup é€»è¾‘ï¼Œå¹¶åœæ­¢æˆ–æ’¤æ¶ˆ setup å‡½æ•°æ­£åœ¨åšçš„ä»»ä½•äº‹æƒ…ã€‚å¦‚æœè¿™ä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œ[è¯·å®ç° cleanup å‡½æ•°](https://zh-hans.react.dev/learn/synchronizing-with-effects#how-to-handle-the-effect-firing-twice-in-development)ã€‚
- å¦‚æœä½ çš„ä¸€äº›ä¾èµ–é¡¹æ˜¯ç»„ä»¶å†…éƒ¨å®šä¹‰çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œåˆ™å­˜åœ¨è¿™æ ·çš„é£é™©ï¼Œå³å®ƒä»¬å°† **å¯¼è‡´ Effect è¿‡å¤šåœ°é‡æ–°è¿è¡Œ**ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¯·åˆ é™¤ä¸å¿…è¦çš„ [å¯¹è±¡](https://zh-hans.react.dev/reference/react/useEffect#removing-unnecessary-object-dependencies) å’Œ [å‡½æ•°](https://zh-hans.react.dev/reference/react/useEffect#removing-unnecessary-function-dependencies) ä¾èµ–é¡¹ã€‚ä½ è¿˜å¯ä»¥ [æŠ½ç¦»çŠ¶æ€æ›´æ–°](https://zh-hans.react.dev/reference/react/useEffect#updating-state-based-on-previous-state-from-an-effect) å’Œ [éå“åº”å¼çš„é€»è¾‘](https://zh-hans.react.dev/reference/react/useEffect#reading-the-latest-props-and-state-from-an-effect) åˆ° Effect ä¹‹å¤–ã€‚
- å¦‚æœä½ çš„ Effect ä¸æ˜¯ç”±äº¤äº’ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰å¼•èµ·çš„ï¼Œé‚£ä¹ˆ React ä¼šè®©æµè§ˆå™¨ **åœ¨è¿è¡Œ Effect å‰å…ˆç»˜åˆ¶å‡ºæ›´æ–°åçš„å±å¹•**ã€‚å¦‚æœä½ çš„ Effect æ­£åœ¨åšä¸€äº›è§†è§‰ç›¸å…³çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼Œå®šä½ä¸€ä¸ª tooltipï¼‰ï¼Œå¹¶ä¸”æœ‰æ˜¾è‘—çš„å»¶è¿Ÿï¼ˆä¾‹å¦‚ï¼Œå®ƒä¼šé—ªçƒï¼‰ï¼Œé‚£ä¹ˆå°† `useEffect` æ›¿æ¢ä¸º [`useLayoutEffect`](https://zh-hans.react.dev/reference/react/useLayoutEffect)ã€‚
- å³ä½¿ä½ çš„ Effect æ˜¯ç”±ä¸€ä¸ªäº¤äº’ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰å¼•èµ·çš„ï¼Œ**æµè§ˆå™¨ä¹Ÿå¯èƒ½åœ¨å¤„ç† Effect å†…éƒ¨çš„çŠ¶æ€æ›´æ–°ä¹‹å‰é‡æ–°ç»˜åˆ¶å±å¹•**ã€‚é€šå¸¸ï¼Œè¿™å°±æ˜¯ä½ æƒ³è¦çš„ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ ä¸€å®šè¦é˜»æ­¢æµè§ˆå™¨é‡æ–°ç»˜åˆ¶å±å¹•ï¼Œåˆ™éœ€è¦ç”¨ [`useLayoutEffect`](https://zh-hans.react.dev/reference/react/useLayoutEffect) æ›¿æ¢ `useEffect`ã€‚
- Effect **åªåœ¨å®¢æˆ·ç«¯ä¸Šè¿è¡Œ**ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸­ä¸ä¼šè¿è¡Œã€‚

### ç”¨æ³•

#### è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿ

useEffect é€‚åˆäºè°ƒç”¨å¤–éƒ¨æ¥å£ã€ä½¿ç”¨å®šæ—¶å™¨ã€ä½¿ç”¨ JS åŸç”Ÿäº‹ä»¶è®¢é˜…ã€ä½¿ç”¨ç¬¬ä¸‰æ–¹åŠ¨ç”»åº“ã€ä½¿ç”¨ç¬¬ä¸‰æ–¹åœ°å›¾ç»„ä»¶ç­‰åœºæ™¯ã€‚

ä½ éœ€è¦å‘ `useEffect` ä¼ é€’ä¸¤ä¸ªå‚æ•°ï¼š

1. ä¸€ä¸ª setup å‡½æ•°ï¼Œå…¶ setup ä»£ç ç”¨æ¥è¿æ¥åˆ°è¯¥ç³»ç»Ÿã€‚
    - å®ƒåº”è¯¥è¿”å›ä¸€ä¸ª **æ¸…ç†å‡½æ•°**ï¼ˆcleanupï¼‰ï¼Œå…¶ cleanup ä»£ç ç”¨æ¥ä¸è¯¥ç³»ç»Ÿæ–­å¼€è¿æ¥ã€‚
2. ä¸€ä¸ªä¾èµ–é¡¹åˆ—è¡¨ï¼ŒåŒ…æ‹¬è¿™äº›å‡½æ•°ä½¿ç”¨çš„æ¯ä¸ªç»„ä»¶å†…çš„å€¼ã€‚

React åœ¨å¿…è¦æ—¶ä¼šè°ƒç”¨ setup å’Œ cleanupï¼Œè¿™å¯èƒ½ä¼š**å‘ç”Ÿå¤šæ¬¡**ï¼š

1. å°†ç»„ä»¶æŒ‚è½½åˆ°é¡µé¢æ—¶ï¼Œå°†è¿è¡Œ setup ä»£ç ã€‚
2. é‡æ–°æ¸²æŸ“ä¾èµ–é¡¹å˜æ›´çš„ç»„ä»¶åï¼š
    - é¦–å…ˆï¼Œä½¿ç”¨æ—§çš„ props å’Œ state è¿è¡Œ cleanup ä»£ç ã€‚
    - ç„¶åï¼Œä½¿ç”¨æ–°çš„ props å’Œ state è¿è¡Œ setup ä»£ç ã€‚
3. å½“ç»„ä»¶ä»é¡µé¢å¸è½½åï¼Œcleanup ä»£ç å°†è¿è¡Œæœ€åä¸€æ¬¡ã€‚

#### åœ¨è‡ªå®šä¹‰ Hook ä¸­å°è£… Effect

Effect æ˜¯ä¸€ç§è„±å›´æœºåˆ¶ï¼šå½“ä½ éœ€è¦â€œèµ°å‡º React ä¹‹å¤–â€æˆ–è€…å½“ä½ çš„ä½¿ç”¨åœºæ™¯æ²¡æœ‰æ›´å¥½çš„å†…ç½®è§£å†³æ–¹æ¡ˆæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚å¦‚æœä½ å‘ç°è‡ªå·±ç»å¸¸éœ€è¦æ‰‹åŠ¨ç¼–å†™ Effectï¼Œé‚£ä¹ˆè¿™é€šå¸¸è¡¨æ˜ä½ éœ€è¦ä¸ºç»„ä»¶æ‰€ä¾èµ–çš„é€šç”¨è¡Œä¸ºæå–ä¸€äº› [è‡ªå®šä¹‰ Hook](https://zh-hans.react.dev/learn/reusing-logic-with-custom-hooks)ã€‚

> è„±å›´æœºåˆ¶ï¼šæœ‰äº›ç»„ä»¶å¯èƒ½éœ€è¦æ§åˆ¶å’ŒåŒæ­¥ React ä¹‹å¤–çš„ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½éœ€è¦ä½¿ç”¨æµè§ˆå™¨ API èšç„¦è¾“å…¥æ¡†ï¼Œæˆ–è€…åœ¨æ²¡æœ‰ React çš„æƒ…å†µä¸‹å®ç°è§†é¢‘æ’­æ”¾å™¨ï¼Œæˆ–è€…è¿æ¥å¹¶ç›‘å¬è¿œç¨‹æœåŠ¡å™¨çš„æ¶ˆæ¯ã€‚åœ¨æœ¬ç« ä¸­ï¼Œä½ å°†å­¦ä¹ åˆ°ä¸€äº›è„±å›´æœºåˆ¶ï¼Œè®©ä½ å¯ä»¥â€œèµ°å‡ºâ€ React å¹¶è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿã€‚å¤§å¤šæ•°åº”ç”¨é€»è¾‘å’Œæ•°æ®æµä¸åº”è¯¥ä¾èµ–è¿™äº›åŠŸèƒ½ã€‚

#### ä½¿ç”¨ Effect è¯·æ±‚æ•°æ®

å‡è®¾æœ‰å¦‚ä¸‹ä»£ç ï¼š

```javascript
import { useState, useEffect } from 'react';
import { fetchBio } from './api.js';

export default function Page() {
    const [person, setPerson] = useState('Alice');
    const [bio, setBio] = useState(null);

    useEffect(() => {
        let ignore = false;
        setBio(null);
        fetchBio(person).then(result => {
            if (!ignore) {
                setBio(result);
            }
        });
        return () => {
            ignore = true;
        };
    }, [person]);

// ...
```

æ³¨æ„ï¼Œ`ignore` å˜é‡è¢«åˆå§‹åŒ–ä¸º `false`ï¼Œå¹¶ä¸”åœ¨ cleanup ä¸­è¢«è®¾ç½®ä¸º `true`ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ä¸ä¼šå—åˆ°â€œç«äº‰æ¡ä»¶â€çš„å½±å“ï¼šç½‘ç»œå“åº”å¯èƒ½ä¼šä»¥ä¸ä½ å‘é€çš„ä¸åŒçš„é¡ºåºåˆ°è¾¾ã€‚æ¯”å¦‚åœ¨ä¸¤ä¸ª tab é¡µä¸­æ¥å›å¿«é€Ÿåˆ‡æ¢ï¼Œä» 1 åˆ‡åˆ° 2 å†ç§’åˆ‡å› 1ï¼Œåˆ‡åˆ° 2 æ—¶ï¼Œ`ignore = false`ï¼Œå½“ç§’åˆ‡å› 1 æ—¶ï¼Œ2 ç”±äºè¢«é”€æ¯ï¼Œè§¦å‘äº† cleanupï¼Œæ¥å£è¯·æ±‚åˆ°çš„æ•°æ®å°†ä¼šè¢«é—å¼ƒï¼Œä»è€Œé¿å…äº† 1 é¡µé¢å…ˆæ¸²æŸ“ 2 çš„æ•°æ®ååˆæ¸²æŸ“ 1 çš„æ•°æ®ã€‚

åœ¨ Effect ä¸­ä½¿ç”¨ `fetch` æ˜¯è¯·æ±‚æ•°æ®çš„ä¸€ç§æµè¡Œæ–¹å¼ï¼Œç‰¹åˆ«æ˜¯åœ¨å®Œå…¨çš„å®¢æˆ·ç«¯åº”ç”¨ç¨‹åºä¸­ã€‚ç„¶è€Œï¼Œè¿™æ˜¯ä¸€ç§éå¸¸æ‰‹åŠ¨çš„æ–¹æ³•ï¼Œè€Œä¸”æœ‰å¾ˆå¤§çš„ç¼ºç‚¹ï¼š

- **Effect ä¸åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ**ã€‚è¿™æ„å‘³ç€åˆå§‹æœåŠ¡å™¨æ¸²æŸ“çš„ HTML å°†åªåŒ…å«æ²¡æœ‰æ•°æ®çš„ loading çŠ¶æ€ã€‚å®¢æˆ·ç«¯ç”µè„‘ä»…ä¸ºäº†å‘ç°å®ƒç°åœ¨éœ€è¦åŠ è½½æ•°æ®ï¼Œå°†ä¸å¾—ä¸ä¸‹è½½æ‰€æœ‰çš„è„šæœ¬æ¥æ¸²æŸ“ä½ çš„åº”ç”¨ç¨‹åºã€‚è¿™å¹¶ä¸é«˜æ•ˆã€‚
- **åœ¨ Effect ä¸­ç›´æ¥è¯·æ±‚æ•°æ®å¾ˆå®¹æ˜“å¯¼è‡´â€œç½‘ç»œç€‘å¸ƒâ€**ã€‚å½“ä½ æ¸²æŸ“çˆ¶ç»„ä»¶æ—¶ï¼Œå®ƒä¼šè¯·æ±‚ä¸€äº›æ•°æ®ï¼Œå†æ¸²æŸ“å­ç»„ä»¶ï¼Œç„¶åé‡å¤è¿™æ ·çš„è¿‡ç¨‹æ¥è¯·æ±‚å­ç»„ä»¶çš„æ•°æ®ã€‚å¦‚æœç½‘ç»œä¸æ˜¯å¾ˆå¿«ï¼Œè¿™å°†æ¯”å¹¶è¡Œè¯·æ±‚æ‰€æœ‰æ•°æ®è¦æ…¢å¾—å¤šã€‚
- **åœ¨ Effect ä¸­ç›´æ¥è¯·æ±‚æ•°æ®é€šå¸¸æ„å‘³ç€ä½ ä¸ä¼šé¢„åŠ è½½æˆ–ç¼“å­˜æ•°æ®**ã€‚ä¾‹å¦‚ï¼Œå¦‚æœç»„ä»¶å¸è½½åé‡æ–°æŒ‚è½½ï¼Œå®ƒä¸å¾—ä¸å†æ¬¡è¯·æ±‚æ•°æ®ã€‚
- **è¿™ä¸ç¬¦åˆå·¥æ•ˆå­¦**ã€‚åœ¨è°ƒç”¨ `fetch` æ—¶ï¼Œéœ€è¦ç¼–å†™å¤§é‡æ ·æ¿ä»£ç ï¼Œä»¥é¿å…åƒ**ç«äº‰æ¡ä»¶**è¿™æ ·çš„ bugã€‚

å¯ä»¥è€ƒè™‘ä½¿ç”¨ Next.js ç­‰æ¡†æ¶çš„å†…ç½®æ•°æ®è·å–æœºåˆ¶ï¼Œæˆ–è€…è‡ªè¡Œæ„å»ºå®¢æˆ·ç«¯ç¼“å­˜ã€‚

#### æŒ‡å®šå“åº”å¼ä¾èµ–é¡¹

Effect ä»£ç ä¸­ä½¿ç”¨çš„æ¯ä¸ª**å“åº”å¼å€¼**éƒ½å¿…é¡»å£°æ˜ä¸ºä¾èµ–é¡¹ï¼Œå“åº”å¼å€¼åŒ…æ‹¬ props å’Œç›´æ¥åœ¨ç»„ä»¶å†…å£°æ˜çš„æ‰€æœ‰å˜é‡å’Œå‡½æ•°ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•ä¾èµ–é¡¹ï¼Œå¹¶ä¸”ä¸å¸Œæœ›ç»„ä»¶çš„æ¯æ¬¡å•ç‹¬æ¸²æŸ“ï¼ˆå’Œé‡æ–°æ¸²æŸ“ï¼‰ä¹‹ååå¤æ‰§è¡Œ Effectï¼Œå°†ç¬¬äºŒä¸ªå‚æ•°è®¾ç½®ä¸ºç©ºæ•°ç»„`[]`ã€‚

#### åœ¨ Effect ä¸­æ ¹æ®å…ˆå‰ state æ›´æ–° state 

å½“ä½ æƒ³è¦åœ¨ Effect ä¸­æ ¹æ®å…ˆå‰çš„ state æ›´æ–° state æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼š

```javascript
function Counter() {
    const [count, setCount] = useState(0);

    useEffect(() => {
        const intervalId = setInterval(() => {
            setCount(count + 1); // ä½ æƒ³è¦æ¯ç§’é€’å¢è¯¥è®¡æ•°å™¨...
        }, 1000)
        return () => clearInterval(intervalId);
    }, [count]); // ğŸš© ... ä½†æ˜¯æŒ‡å®š `count` ä½œä¸ºä¾èµ–é¡¹æ€»æ˜¯é‡ç½®é—´éš”å®šæ—¶å™¨ã€‚
    // ...
}
```

å› ä¸º `count`  æ˜¯ä¸€ä¸ªå“åº”å¼å€¼ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ä¾èµ–é¡¹åˆ—è¡¨ä¸­æŒ‡å®šå®ƒã€‚ä½†æ˜¯ï¼Œè¿™ä¼šå¯¼è‡´ Effect åœ¨æ¯æ¬¡ `count` æ›´æ”¹æ—¶å†æ¬¡æ‰§è¡Œ cleanup å’Œ setupã€‚è¿™å¹¶ä¸ç†æƒ³ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°†`c => c + 1`çŠ¶æ€æ›´æ–°å™¨ä¼ é€’ç»™ setCountï¼Œç°åœ¨ Effect ä¸å†éœ€è¦ä¾èµ– countï¼Œæ¯æ¬¡ `count` æ›´æ”¹æ—¶ï¼Œå®ƒéƒ½ä¸éœ€è¦æ¸…ç†ï¼ˆcleanupï¼‰å’Œè®¾ç½®ï¼ˆsetupï¼‰é—´éš”å®šæ—¶å™¨ã€‚

#### åˆ é™¤ä¸å¿…è¦çš„ä¾èµ–é¡¹

å¦‚æœ Effect çš„æ¯æ¬¡æ›´æ–°ä¾èµ–äºä¸€ä¸ªå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œå¦‚æœè¿™ä¸ªå¯¹è±¡æˆ–è€…å‡½æ•°åˆ›å»ºäºæ¸²æŸ“æœŸé—´ï¼Œé‚£ Effect å¯èƒ½ä¼šé¢‘ç¹æ‰§è¡Œï¼Œå› ä¸ºæ¯æ¬¡ç»„ä»¶æ›´æ–°æ‰§è¡Œæ¸²æŸ“ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡æˆ–è€…å‡½æ•°ã€‚è¯·é¿å…ä½¿ç”¨æ¸²æŸ“æœŸé—´åˆ›å»ºçš„å¯¹è±¡ä½œä¸ºä¾èµ–é¡¹ã€‚ç›¸åï¼Œåœ¨ Effect å†…éƒ¨åˆ›å»ºå¯¹è±¡ï¼š

```javascript
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
    const [message, setMessage] = useState('');
    
    // é¿å…ä½¿ç”¨æ¸²æŸ“æœŸé—´åˆ›å»ºçš„å¯¹è±¡
    // const options = {
    //     serverUrl: serverUrl,
    //     roomId: roomId
    // };

    useEffect(() => {
        // ç°åœ¨åªæœ‰åœ¨ roomId å˜åŒ–åï¼Œæ‰ä¼šé‡æ–°æ‰§è¡Œ Effect å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡
		const options = {
        	serverUrl: serverUrl,
        	roomId: roomId
    	};
        const connection = createConnection(options);
        connection.connect();
        return () => connection.disconnect();
    }, [roomId]);
// ...
```

#### ä» Effect è¯»å–æœ€æ–°çš„ props å’Œ state

æ­£å¸¸æƒ…å†µä¸‹ï¼Œåœ¨ Effect ä¸­è¯»å–å“åº”å¼å€¼æ—¶ï¼Œå¿…é¡»å°†å…¶æ·»åŠ ä¸ºä¾èµ–é¡¹ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿ä½ çš„ Effect å¯¹è¯¥å€¼çš„æ¯æ¬¡æ›´æ”¹éƒ½â€œä½œå‡ºå“åº”â€ã€‚ä½†æ˜¯æŸäº›æƒ…å†µä¸‹ï¼Œåªæ˜¯æƒ³è·å–æœ€æ–°çš„ props å’Œ state è€Œä¸è§¦å‘å“åº”ã€‚

```javascript
function Page({ url, shoppingCart }) {
    const onVisit = useEffectEvent(visitedUrl => {
        logVisit(visitedUrl, shoppingCart.length)
    });

    useEffect(() => {
        onVisit(url);
    }, [url]); // âœ… æ‰€æœ‰å£°æ˜çš„ä¾èµ–é¡¹
    // ...
}
```

é€šè¿‡åœ¨ `onVisit` ä¸­è¯»å– `shoppingCart`ï¼Œç¡®ä¿äº† `shoppingCart` ä¸ä¼šä½¿ Effect é‡æ–°è¿è¡Œã€‚



## useLayoutEffect

å¦‚æœ Effect ä¸€å®šè¦é˜»æ­¢æµè§ˆå™¨ç»˜åˆ¶å±å¹•ï¼Œä½¿ç”¨ useLayoutEffect æ›¿æ¢ useEffectã€‚useLayoutEffect æ˜¯ useEffect çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œåœ¨æµè§ˆå™¨é‡æ–°ç»˜åˆ¶å±å¹•ä¹‹å‰è§¦å‘ã€‚

æ¯”å¦‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå…ƒç´ çš„æ¸²æŸ“éœ€è¦ä¾æ®å½“å‰çš„ dom ä½ç½®æ¥è¿›è¡Œè®¡ç®—ï¼Œä½¿ç”¨ useEffectï¼ŒEffect å‡½æ•°ä¼šåœ¨æ“ä½œ dom ä¹‹åå¼‚æ­¥æ‰§è¡Œï¼Œæ‰€ä»¥å¯èƒ½çœ‹åˆ°é—ªçƒï¼ˆç»„ä»¶çš„ä¸¤æ¬¡æ¸²æŸ“ä½ç½®ä¸åŒï¼‰ã€‚ä½¿ç”¨ useLayoutEffect åˆ™æ˜¯åœ¨åŒä¸€ä¸ª JS æ‰§è¡Œç‰‡æ®µä¸­åŒæ­¥æ‰§è¡Œ Effect å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯é˜»å¡æ¸²æŸ“ï¼Œå¹¶åœ¨è®¡ç®—ä¹‹åæ‰§è¡Œæ¸²æŸ“ï¼Œçœ‹ä¸Šå»çš„æ•ˆæœå°±å¥½åƒé¡µé¢åªæ¸²æŸ“äº†ä¸€æ¬¡ï¼Œä»è€Œé¿å…é—ªçƒã€‚

ä½†æ˜¯å¦‚æœ Effect çš„æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå°†å¯èƒ½å¯¼è‡´æ¸²æŸ“è¢«é˜»å¡å¤ªä¹…ï¼Œå°½é‡é¿å…è¿™ç§æƒ…å†µã€‚



## useReducer

### useReducer(reducer, initialArg, init?) 

**å‚æ•°**

- `reducer`ï¼šç”¨äºæ›´æ–° state çš„çº¯å‡½æ•°ã€‚å‚æ•°ä¸º state å’Œ actionï¼Œè¿”å›å€¼æ˜¯æ›´æ–°åçš„ stateã€‚state ä¸ action å¯ä»¥æ˜¯ä»»æ„åˆæ³•å€¼ã€‚
- `initialArg`ï¼šç”¨äºåˆå§‹åŒ– state çš„ä»»æ„å€¼ã€‚åˆå§‹å€¼çš„è®¡ç®—é€»è¾‘å–å†³äºæ¥ä¸‹æ¥çš„ `init` å‚æ•°ã€‚
- **å¯é€‰å‚æ•°** `init`ï¼šç”¨äºè®¡ç®—åˆå§‹å€¼çš„å‡½æ•°ã€‚å¦‚æœå­˜åœ¨ï¼Œä½¿ç”¨ `init(initialArg)` çš„æ‰§è¡Œç»“æœä½œä¸ºåˆå§‹å€¼ï¼Œå¦åˆ™ä½¿ç”¨ `initialArg`ã€‚

**è¿”å›**

1. å½“å‰çš„ stateã€‚åˆæ¬¡æ¸²æŸ“æ—¶ï¼Œå®ƒæ˜¯ `init(initialArg)` æˆ– `initialArg` ï¼ˆå¦‚æœæ²¡æœ‰ `init` å‡½æ•°ï¼‰ã€‚
2. [`dispatch` å‡½æ•°](https://zh-hans.react.dev/reference/react/useReducer#dispatch)ã€‚ç”¨äºæ›´æ–° state å¹¶è§¦å‘ç»„ä»¶çš„é‡æ–°æ¸²æŸ“ã€‚

### `dispatch` å‡½æ•° 

**å‚æ•°**

- `action`ï¼šç”¨æˆ·æ‰§è¡Œçš„æ“ä½œã€‚å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„å€¼ã€‚é€šå¸¸æ¥è¯´ action æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä¸­ `type` å±æ€§æ ‡è¯†ç±»å‹ï¼Œå…¶å®ƒå±æ€§æºå¸¦é¢å¤–ä¿¡æ¯ã€‚

**è¿”å›**

dispatch å‡½æ•°æ²¡æœ‰è¿”å›å€¼ã€‚

**æ³¨æ„äº‹é¡¹**

- `useReducer` æ˜¯ä¸€ä¸ª Hookï¼Œæ‰€ä»¥åªèƒ½åœ¨ **ç»„ä»¶çš„é¡¶å±‚ä½œç”¨åŸŸ** æˆ–è‡ªå®šä¹‰ Hook ä¸­è°ƒç”¨ï¼Œè€Œä¸èƒ½åœ¨å¾ªç¯æˆ–æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨ã€‚å¦‚æœä½ æœ‰è¿™ç§éœ€æ±‚ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç»„ä»¶ï¼Œå¹¶æŠŠ state ç§»å…¥å…¶ä¸­ã€‚
- ä¸¥æ ¼æ¨¡å¼ä¸‹ React ä¼š **è°ƒç”¨ä¸¤æ¬¡ reducer å’Œåˆå§‹åŒ–å‡½æ•°**ï¼Œè¿™å¯ä»¥ [å¸®åŠ©ä½ å‘ç°æ„å¤–çš„å‰¯ä½œç”¨](https://zh-hans.react.dev/reference/react/useReducer#my-reducer-or-initializer-function-runs-twice)ã€‚è¿™åªæ˜¯å¼€å‘æ¨¡å¼ä¸‹çš„è¡Œä¸ºï¼Œå¹¶ä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒã€‚åªè¦ reducer å’Œåˆå§‹åŒ–å‡½æ•°æ˜¯çº¯å‡½æ•°ï¼ˆç†åº”å¦‚æ­¤ï¼‰å°±ä¸ä¼šæ”¹å˜ä½ çš„é€»è¾‘ã€‚å…¶ä¸­ä¸€ä¸ªè°ƒç”¨ç»“æœä¼šè¢«å¿½ç•¥ã€‚
- `dispatch` å‡½æ•° **æ˜¯ä¸ºä¸‹ä¸€æ¬¡æ¸²æŸ“è€Œæ›´æ–° state**ã€‚å› æ­¤åœ¨è°ƒç”¨ `dispatch` å‡½æ•°åè¯»å– state [å¹¶ä¸ä¼šæ‹¿åˆ°æ›´æ–°åçš„å€¼](https://zh-hans.react.dev/reference/react/useReducer#ive-dispatched-an-action-but-logging-gives-me-the-old-state-value)ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½è·å–åˆ°è°ƒç”¨å‰çš„å€¼ã€‚
- å¦‚æœä½ æä¾›çš„æ–°å€¼ä¸å½“å‰çš„ `state` ç›¸åŒï¼ˆä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¯”è¾ƒï¼‰ï¼ŒReact ä¼š **è·³è¿‡ç»„ä»¶å’Œå­ç»„ä»¶çš„é‡æ–°æ¸²æŸ“**ï¼Œè¿™æ˜¯ä¸€ç§ä¼˜åŒ–æ‰‹æ®µã€‚è™½ç„¶åœ¨è·³è¿‡é‡æ–°æ¸²æŸ“å‰ React å¯èƒ½ä¼šè°ƒç”¨ä½ çš„ç»„ä»¶ï¼Œä½†æ˜¯è¿™ä¸åº”è¯¥å½±å“ä½ çš„ä»£ç ã€‚
- React [ä¼šæ‰¹é‡æ›´æ–° state](https://zh-hans.react.dev/learn/queueing-a-series-of-state-updates)ã€‚state ä¼šåœ¨ **æ‰€æœ‰äº‹ä»¶å‡½æ•°æ‰§è¡Œå®Œæ¯•** å¹¶ä¸”å·²ç»è°ƒç”¨è¿‡å®ƒçš„ `set` å‡½æ•°åè¿›è¡Œæ›´æ–°ï¼Œè¿™å¯ä»¥é˜²æ­¢åœ¨ä¸€ä¸ªäº‹ä»¶ä¸­å¤šæ¬¡è¿›è¡Œé‡æ–°æ¸²æŸ“ã€‚å¦‚æœåœ¨è®¿é—® DOM ç­‰æå°‘æ•°æƒ…å†µä¸‹éœ€è¦å¼ºåˆ¶ React æå‰æ›´æ–°ï¼Œå¯ä»¥ä½¿ç”¨ [`flushSync`](https://zh-hans.react.dev/reference/react-dom/flushSync)ã€‚

### ç”¨æ³•

#### å‘ç»„ä»¶æ·»åŠ  reducer 

åœ¨ç»„ä»¶çš„é¡¶å±‚ä½œç”¨åŸŸè°ƒç”¨ `useReducer` æ¥åˆ›å»ºä¸€ä¸ªç”¨äºç®¡ç†çŠ¶æ€ï¼ˆstateï¼‰çš„ [reducer](https://zh-hans.react.dev/learn/extracting-state-logic-into-a-reducer)ã€‚

```javascript
import { useReducer } from 'react';

function reducer(state, action) {
    if (action.type === 'incremented_age') {
        return {
            age: state.age + 1
        };
    }
    throw Error('Unknown action.');
}

export default function Counter() {
    const [state, dispatch] = useReducer(reducer, { age: 42 });

    return (
        <>
            <button onClick={() => {
                dispatch({ type: 'incremented_age' })
            }}>
                Increment age
            </button>
            <p>Hello! You are {state.age}.</p>
        </>
    );
}
```

`useReducer` å’Œ [`useState`](https://zh-hans.react.dev/reference/react/useState) éå¸¸ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒå¯ä»¥è®©ä½ æŠŠçŠ¶æ€æ›´æ–°é€»è¾‘ä»äº‹ä»¶å¤„ç†å‡½æ•°ä¸­ç§»åŠ¨åˆ°ç»„ä»¶å¤–éƒ¨ã€‚



## useRef

### useRef(initialValue)

**å‚æ•°**

- `initialValue`ï¼šref å¯¹è±¡çš„ `current` å±æ€§çš„åˆå§‹å€¼ã€‚å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„å€¼ã€‚è¿™ä¸ªå‚æ•°åœ¨é¦–æ¬¡æ¸²æŸ“åè¢«å¿½ç•¥ã€‚

**è¿”å›**

`useRef` è¿”å›ä¸€ä¸ªåªæœ‰ä¸€ä¸ªå±æ€§çš„å¯¹è±¡:

- `current`ï¼šåˆå§‹å€¼ä¸ºä¼ é€’çš„ `initialValue`ã€‚ä¹‹åå¯ä»¥å°†å…¶è®¾ç½®ä¸ºå…¶ä»–å€¼ã€‚å¦‚æœå°† ref å¯¹è±¡ä½œä¸ºä¸€ä¸ª JSX èŠ‚ç‚¹çš„ `ref` å±æ€§ä¼ é€’ç»™ Reactï¼ŒReact å°†ä¸ºå®ƒè®¾ç½® `current` å±æ€§ã€‚

åœ¨åç»­çš„æ¸²æŸ“ä¸­ï¼Œ`useRef` å°†è¿”å›åŒä¸€ä¸ªå¯¹è±¡ã€‚

**æ³¨æ„äº‹é¡¹**

- å¯ä»¥ä¿®æ”¹ `ref.current` å±æ€§ã€‚ä¸ state ä¸åŒï¼Œå®ƒæ˜¯å¯å˜çš„ã€‚ç„¶è€Œï¼Œå¦‚æœå®ƒæŒæœ‰ä¸€ä¸ªç”¨äºæ¸²æŸ“çš„å¯¹è±¡ï¼ˆä¾‹å¦‚ state çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œé‚£ä¹ˆå°±ä¸åº”è¯¥ä¿®æ”¹è¿™ä¸ªå¯¹è±¡ã€‚
- æ”¹å˜ `ref.current` å±æ€§æ—¶ï¼ŒReact ä¸ä¼šé‡æ–°æ¸²æŸ“ç»„ä»¶ã€‚React ä¸çŸ¥é“å®ƒä½•æ—¶ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå› ä¸º ref æ˜¯ä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡ã€‚
- é™¤äº† [åˆå§‹åŒ–](https://zh-hans.react.dev/reference/react/useRef#avoiding-recreating-the-ref-contents) å¤–ä¸è¦åœ¨æ¸²æŸ“æœŸé—´å†™å…¥æˆ–è€…è¯»å– `ref.current`ï¼Œå¦åˆ™ä¼šä½¿ç»„ä»¶è¡Œä¸ºå˜å¾—ä¸å¯é¢„æµ‹ã€‚
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReact å°†ä¼š **è°ƒç”¨ä¸¤æ¬¡ç»„ä»¶æ–¹æ³•**ï¼Œè¿™æ˜¯ä¸ºäº† [å¸®åŠ©å‘ç°æ„å¤–é—®é¢˜](https://zh-hans.react.dev/reference/react/useState#my-initializer-or-updater-function-runs-twice)ã€‚ä½†è¿™åªæ˜¯å¼€å‘æ¨¡å¼ä¸‹çš„è¡Œä¸ºï¼Œä¸ä¼šå½±å“ç”Ÿäº§æ¨¡å¼ã€‚æ¯ä¸ª ref å¯¹è±¡éƒ½å°†ä¼šåˆ›å»ºä¸¤æ¬¡ï¼Œä½†æ˜¯å…¶ä¸­ä¸€ä¸ªç‰ˆæœ¬å°†è¢«ä¸¢å¼ƒã€‚å¦‚æœä½¿ç”¨çš„æ˜¯ç»„ä»¶çº¯å‡½æ•°ï¼ˆä¹Ÿåº”å½“å¦‚æ­¤ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ä¼šå½±å“å…¶è¡Œä¸ºã€‚

### ç”¨æ³•

#### ä½¿ç”¨ ref å¼•ç”¨ä¸€ä¸ªå€¼

useRef è¿”å›ä¸€ä¸ªå…·æœ‰å•ä¸ª current å±æ€§çš„ ref å¯¹è±¡ï¼Œåœ¨åç»­çš„æ¸²æŸ“ä¸­ï¼ŒuseRef å°†è¿”å›ç›¸åŒçš„å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡æ”¹å˜ current å±æ€§æ¥å­˜å‚¨ä¿¡æ¯ï¼Œå¹¶åœ¨ä¹‹åè¯»å–ã€‚**æ”¹å˜ ref ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“**ï¼Œè¿™æ„å‘³ç€ ref æ˜¯å­˜å‚¨ä¸€äº›ä¸å½±å“ç»„ä»¶è§†å›¾è¾“å‡ºä¿¡æ¯çš„å®Œç¾é€‰æ‹©ã€‚

#### é€šè¿‡ ref æ“ä½œ DOM

å½“ React åˆ›å»º DOM èŠ‚ç‚¹å¹¶å°†å…¶æ¸²æŸ“åˆ°å±å¹•æ—¶ï¼ŒReact å°†ä¼šæŠŠ DOM èŠ‚ç‚¹è®¾ç½®ä¸º ref å¯¹è±¡çš„`current`å±æ€§ã€‚ç°åœ¨å¯ä»¥å€ŸåŠ© ref å¯¹è±¡è®¿é—®`<input>`çš„ DOM èŠ‚ç‚¹ï¼Œå¹¶ä¸”å¯ä»¥è°ƒç”¨ç±»ä¼¼äº`focus()`çš„æ–¹æ³•ï¼š

```javascript
import { useRef } from 'react';

export default function Form() {
    const inputRef = useRef(null);

    function handleClick() {
        inputRef.current.focus();
    }

    return (
        <>
            <input ref={inputRef} />
            <button onClick={handleClick}>
                èšç„¦è¾“å…¥æ¡†
            </button>
        </>
    );
}
```

#### é€šè¿‡ forwardRef å°† ref ä¼ é€’ç»™çˆ¶ç»„ä»¶

åŸç”Ÿçš„æ ‡ç­¾å¯ä»¥æ‹¿åˆ°å®ƒçš„ refï¼Œå¦‚æœæ˜¯è‡ªå®šä¹‰çš„ç»„ä»¶ï¼Œå¹¶æ²¡æœ‰æš´éœ²å®ƒä»¬å†…éƒ¨ DOM èŠ‚ç‚¹çš„ refï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š

```javascript
import { forwardRef } from 'react';

const MyInput = forwardRef(({ value, onChange }, ref) => {
    return (
        <input
            value={value}
            onChange={onChange}
            ref={ref}
        />
    );
});

export default MyInput;
```

çˆ¶ç»„ä»¶ä¸­ï¼š

```javascript
function Form() {
    const ref = useRef(null);

    function handleClick() {
        ref.current.focus();
    }

    return (
        <form>
            <MyInput label="Enter your name:" ref={ref} />
            <button type="button" onClick={handleClick}>
                ç¼–è¾‘
            </button>
        </form>
    );
}
```



## useImperativeHandle

### useImperativeHandle(ref, createHandle, dependencies?)

**å‚æ•°**

- `ref`ï¼šè¯¥ `ref` æ˜¯ä½ ä» [`forwardRef` æ¸²æŸ“å‡½æ•°](https://zh-hans.react.dev/reference/react/forwardRef#render-function) ä¸­è·å¾—çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚
- `createHandle`ï¼šè¯¥å‡½æ•°æ— éœ€å‚æ•°ï¼Œå®ƒè¿”å›ä½ æƒ³è¦æš´éœ²çš„ ref çš„å¥æŸ„ã€‚è¯¥å¥æŸ„å¯ä»¥åŒ…å«ä»»ä½•ç±»å‹ã€‚é€šå¸¸ï¼Œä½ ä¼šè¿”å›ä¸€ä¸ªåŒ…å«ä½ æƒ³æš´éœ²çš„æ–¹æ³•çš„å¯¹è±¡ã€‚
- **å¯é€‰çš„** `dependencies`ï¼šå‡½æ•° `createHandle` ä»£ç ä¸­æ‰€ç”¨åˆ°çš„æ‰€æœ‰å“åº”å¼çš„å€¼çš„åˆ—è¡¨ã€‚å“åº”å¼çš„å€¼åŒ…å« propsã€çŠ¶æ€å’Œå…¶ä»–æ‰€æœ‰ç›´æ¥åœ¨ä½ ç»„ä»¶ä½“å†…å£°æ˜çš„å˜é‡å’Œå‡½æ•°ã€‚å€˜è‹¥ä½ çš„ä»£ç æ£€æŸ¥å™¨å·² [ä¸º React é…ç½®å¥½](https://zh-hans.react.dev/learn/editor-setup#linting)ï¼Œå®ƒä¼šéªŒè¯æ¯ä¸€ä¸ªå“åº”å¼çš„å€¼æ˜¯å¦è¢«æ­£ç¡®æŒ‡å®šä¸ºä¾èµ–é¡¹ã€‚è¯¥åˆ—è¡¨çš„é•¿åº¦å¿…é¡»æ˜¯ä¸€ä¸ªå¸¸æ•°é¡¹ï¼Œå¹¶ä¸”å¿…é¡»æŒ‰ç…§ `[dep1, dep2, dep3]` çš„å½¢å¼ç½—åˆ—å„ä¾èµ–é¡¹ã€‚React ä¼šä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¥æ¯”è¾ƒæ¯ä¸€ä¸ªä¾èµ–é¡¹ä¸å…¶å¯¹åº”çš„ä¹‹å‰å€¼ã€‚å¦‚æœä¸€æ¬¡é‡æ–°æ¸²æŸ“å¯¼è‡´æŸäº›ä¾èµ–é¡¹å‘ç”Ÿäº†æ”¹å˜ï¼Œæˆ–ä½ æ²¡æœ‰æä¾›è¿™ä¸ªå‚æ•°åˆ—è¡¨ï¼Œä½ çš„å‡½æ•° `createHandle` å°†ä¼šè¢«é‡æ–°æ‰§è¡Œï¼Œè€Œæ–°ç”Ÿæˆçš„å¥æŸ„åˆ™ä¼šè¢«åˆ†é…ç»™ refã€‚

**è¿”å›å€¼**

useImperativeHandle è¿”å› undefinedã€‚

### ç”¨æ³•

#### å‘çˆ¶ç»„ä»¶æš´éœ²ä¸€ä¸ªè‡ªå®šä¹‰çš„ ref å¥æŸ„

é»˜è®¤æƒ…å†µä¸‹ï¼Œç»„ä»¶ä¸ä¼šå°†å®ƒä»¬çš„ DOM èŠ‚ç‚¹æš´éœ²ç»™çˆ¶ç»„ä»¶ã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œå¦‚æœæƒ³è¦ `MyInput` çš„çˆ¶ç»„ä»¶ [èƒ½è®¿é—®åˆ°](https://zh-hans.react.dev/learn/manipulating-the-dom-with-refs) `<input>` DOM èŠ‚ç‚¹ï¼Œå¿…é¡»é€‰æ‹©ä½¿ç”¨`forwardRef`ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸æ˜¯æƒ³æš´éœ²åŸç”Ÿæ ‡ç­¾ï¼Œè€Œæ˜¯æš´éœ²ä¸€äº›è‡ªå®šä¹‰å†…å®¹ï¼Œæ¯”å¦‚å…¶ä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼š

```javascript
import { forwardRef, useImperativeHandle } from 'react';

const MyInput = forwardRef(function MyInput(props, ref) {
    const inputRef = useRef(null);
    
    useImperativeHandle(ref, () => {
        return {
            focus() {
                inputRef.current.focus();
            },
            scrollIntoView() {
                inputRef.current.scrollIntoView();
            },
        };
    }, []);

    return <input {...props} ref={inputRef} />;
});
```



## useContext

### useContext(SomeContext)

**å‚æ•°**

- `SomeContext`ï¼šå…ˆå‰ç”¨ [`createContext`](https://zh-hans.react.dev/reference/react/createContext) åˆ›å»ºçš„ contextã€‚context æœ¬èº«ä¸åŒ…å«ä¿¡æ¯ï¼Œå®ƒåªä»£è¡¨ä½ å¯ä»¥æä¾›æˆ–ä»ç»„ä»¶ä¸­è¯»å–çš„ä¿¡æ¯ç±»å‹ã€‚

**è¿”å›**

`useContext` ä¸ºè°ƒç”¨ç»„ä»¶è¿”å› context çš„å€¼ã€‚å®ƒè¢«ç¡®å®šä¸ºä¼ é€’ç»™æ ‘ä¸­è°ƒç”¨ç»„ä»¶ä¸Šæ–¹æœ€è¿‘çš„ `SomeContext.Provider` çš„ `value`ã€‚å¦‚æœæ²¡æœ‰è¿™æ ·çš„ providerï¼Œé‚£ä¹ˆè¿”å›å€¼å°†ä¼šæ˜¯ä¸ºåˆ›å»ºè¯¥ context ä¼ é€’ç»™ [`createContext`](https://zh-hans.react.dev/reference/react/createContext) çš„ `defaultValue`ã€‚è¿”å›çš„å€¼å§‹ç»ˆæ˜¯æœ€æ–°çš„ã€‚å¦‚æœ context å‘ç”Ÿå˜åŒ–ï¼ŒReact ä¼šè‡ªåŠ¨é‡æ–°æ¸²æŸ“è¯»å– context çš„ç»„ä»¶ã€‚

**æ³¨æ„äº‹é¡¹**

- ç»„ä»¶ä¸­çš„ `useContext()` è°ƒç”¨ä¸å— **åŒä¸€** ç»„ä»¶è¿”å›çš„ provider çš„å½±å“ã€‚ç›¸åº”çš„ `<Context.Provider>` éœ€è¦ä½äºè°ƒç”¨ `useContext()` çš„ç»„ä»¶ **ä¹‹ä¸Š**ã€‚
- ä» provider æ¥æ”¶åˆ°ä¸åŒçš„ `value` å¼€å§‹ï¼ŒReact è‡ªåŠ¨é‡æ–°æ¸²æŸ“ä½¿ç”¨äº†è¯¥ç‰¹å®š context çš„æ‰€æœ‰å­çº§ã€‚å…ˆå‰çš„å€¼å’Œæ–°çš„å€¼ä¼šä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¥åšæ¯”è¾ƒã€‚ä½¿ç”¨ [`memo`](https://zh-hans.react.dev/reference/react/memo) æ¥è·³è¿‡é‡æ–°æ¸²æŸ“å¹¶ä¸å¦¨ç¢å­çº§æ¥æ”¶åˆ°æ–°çš„ context å€¼ã€‚
- å¦‚æœæ‚¨çš„æ„å»ºç³»ç»Ÿåœ¨è¾“å‡ºä¸­äº§ç”Ÿé‡å¤çš„æ¨¡å—ï¼ˆå¯èƒ½å‘ç”Ÿåœ¨ç¬¦å·é“¾æ¥ä¸­ï¼‰ï¼Œè¿™å¯èƒ½ä¼šç ´å contextã€‚é€šè¿‡ context ä¼ é€’æ•°æ®åªæœ‰åœ¨ç”¨äºä¼ é€’ context çš„ `SomeContext` å’Œç”¨äºè¯»å–æ•°æ®çš„ `SomeContext` æ˜¯å®Œå…¨ç›¸åŒçš„å¯¹è±¡æ—¶æ‰æœ‰æ•ˆï¼Œè¿™æ˜¯ç”± `===` æ¯”è¾ƒå†³å®šçš„ã€‚

### ç”¨æ³•

#### å‘ç»„ä»¶æ ‘æ·±å±‚ä¼ é€’æ•°æ®

```javascript
import { createContext, useContext } from 'react';

const ThemeContext = createContext(null);

export default function MyApp() {
    return (
        <ThemeContext.Provider value="dark">
            <Form />
        </ThemeContext.Provider>
    )
}

function Form() {
    return (
        <Panel title="Welcome">
            <Button>Sign up</Button>
            <Button>Log in</Button>
        </Panel>
    );
}

function Panel({ title, children }) {
    const theme = useContext(ThemeContext);
    const className = 'panel-' + theme;
    return (
        <section className={className}>
            <h1>{title}</h1>
            {children}
        </section>
    )
}

function Button({ children }) {
    const theme = useContext(ThemeContext);
    const className = 'button-' + theme;
    return (
        <button className={className}>
            {children}
        </button>
    );
}
```

å¦‚æœæœ‰å¤šå±‚åµŒå¥—çš„ Providerï¼Œå†…å±‚ç»„ä»¶å°†è·å–ç¦»å®ƒæœ€è¿‘çš„ä¸€å±‚ Provider æ‰€æä¾›çš„å€¼ã€‚

#### åœ¨ä¼ é€’å¯¹è±¡å’Œå‡½æ•°æ—¶ä¼˜åŒ–é‡æ–°æ¸²æŸ“

å¦‚æœå®šä¹‰äº†ä¸€ä¸ªå¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œå¹¶ä¸”é€šè¿‡ context ä¼ é€’ç»™ä¸‹å±‚ï¼Œå½“ç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼ŒReact è¿˜å¿…é¡»é‡æ–°æ¸²æŸ“å†…å±‚è°ƒç”¨è¯¥ context çš„æ‰€æœ‰ç»„ä»¶ã€‚å¯ä»¥ä½¿ç”¨ useCallback åŒ…è£¹å‡½æ•°ï¼Œä½¿ç”¨ useMemo åŒ…è£¹å¯¹è±¡ï¼Œè¿™æ ·åªæœ‰å½“å®ƒä»¬çš„ä¾èµ–é¡¹å‘ç”Ÿå˜åŒ–ï¼Œæ‰ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚



## useMemo

### useMemo(calculateValue, dependencies)

**å‚æ•°**

- `calculateValue`ï¼šè¦ç¼“å­˜è®¡ç®—å€¼çš„å‡½æ•°ã€‚å®ƒåº”è¯¥æ˜¯ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å‚æ•°çš„çº¯å‡½æ•°ï¼Œå¹¶ä¸”å¯ä»¥è¿”å›ä»»æ„ç±»å‹ã€‚React å°†ä¼šåœ¨é¦–æ¬¡æ¸²æŸ“æ—¶è°ƒç”¨è¯¥å‡½æ•°ï¼›åœ¨ä¹‹åçš„æ¸²æŸ“ä¸­ï¼Œå¦‚æœ `dependencies` æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼ŒReact å°†ç›´æ¥è¿”å›ç›¸åŒå€¼ã€‚å¦åˆ™ï¼Œå°†ä¼šå†æ¬¡è°ƒç”¨ `calculateValue` å¹¶è¿”å›æœ€æ–°ç»“æœï¼Œç„¶åç¼“å­˜è¯¥ç»“æœä»¥ä¾¿ä¸‹æ¬¡é‡å¤ä½¿ç”¨ã€‚
- `dependencies`ï¼šæ‰€æœ‰åœ¨ `calculateValue` å‡½æ•°ä¸­ä½¿ç”¨çš„å“åº”å¼å˜é‡ç»„æˆçš„æ•°ç»„ã€‚å“åº”å¼å˜é‡åŒ…æ‹¬ propsã€state å’Œæ‰€æœ‰ä½ ç›´æ¥åœ¨ç»„ä»¶ä¸­å®šä¹‰çš„å˜é‡å’Œå‡½æ•°ã€‚å¦‚æœä½ åœ¨ä»£ç æ£€æŸ¥å·¥å…·ä¸­ [é…ç½®äº† React](https://zh-hans.react.dev/learn/editor-setup#linting)ï¼Œå®ƒå°†ä¼šç¡®ä¿æ¯ä¸€ä¸ªå“åº”å¼æ•°æ®éƒ½è¢«æ­£ç¡®åœ°å®šä¹‰ä¸ºä¾èµ–é¡¹ã€‚ä¾èµ–é¡¹æ•°ç»„çš„é•¿åº¦å¿…é¡»æ˜¯å›ºå®šçš„å¹¶ä¸”å¿…é¡»å†™æˆ `[dep1, dep2, dep3]` è¿™ç§å½¢å¼ã€‚React ä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) å°†æ¯ä¸ªä¾èµ–é¡¹ä¸å…¶ä¹‹å‰çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚

**è¿”å›**

åœ¨åˆæ¬¡æ¸²æŸ“æ—¶ï¼Œ`useMemo` è¿”å›ä¸å¸¦å‚æ•°è°ƒç”¨ `calculateValue` çš„ç»“æœã€‚

åœ¨æ¥ä¸‹æ¥çš„æ¸²æŸ“ä¸­ï¼Œå¦‚æœä¾èµ–é¡¹æ²¡æœ‰å‘ç”Ÿæ”¹å˜ï¼Œå®ƒå°†è¿”å›ä¸Šæ¬¡ç¼“å­˜çš„å€¼ï¼›å¦åˆ™å°†å†æ¬¡è°ƒç”¨ `calculateValue`ï¼Œå¹¶è¿”å›æœ€æ–°ç»“æœã€‚

**æ³¨æ„äº‹é¡¹**

- `useMemo` æ˜¯ä¸€ä¸ª React Hookï¼Œæ‰€ä»¥ä½ åªèƒ½ **åœ¨ç»„ä»¶çš„é¡¶å±‚** æˆ–è€…è‡ªå®šä¹‰ Hook ä¸­è°ƒç”¨å®ƒã€‚ä½ ä¸èƒ½åœ¨å¾ªç¯è¯­å¥æˆ–æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨å®ƒã€‚å¦‚æœ‰éœ€è¦ï¼Œå°†å…¶æå–ä¸ºä¸€ä¸ªæ–°ç»„ä»¶å¹¶ä½¿ç”¨ stateã€‚
- åœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼Œä¸ºäº† [å¸®ä½ å‘ç°æ„å¤–çš„é”™è¯¯](https://zh-hans.react.dev/reference/react/useMemo#my-calculation-runs-twice-on-every-re-render)ï¼ŒReact å°†ä¼š **è°ƒç”¨ä½ çš„è®¡ç®—å‡½æ•°ä¸¤æ¬¡**ã€‚è¿™åªæ˜¯ä¸€ä¸ªå¼€å‘ç¯å¢ƒä¸‹çš„è¡Œä¸ºï¼Œå¹¶ä¸ä¼šå½±å“åˆ°ç”Ÿäº§ç¯å¢ƒã€‚å¦‚æœè®¡ç®—å‡½æ•°æ˜¯ä¸€ä¸ªçº¯å‡½æ•°ï¼ˆå®ƒæœ¬æ¥å°±åº”è¯¥æ˜¯ï¼‰ï¼Œè¿™å°†ä¸ä¼šå½±å“åˆ°ä»£ç é€»è¾‘ã€‚å…¶ä¸­ä¸€æ¬¡çš„è°ƒç”¨ç»“æœå°†è¢«å¿½ç•¥ã€‚
- é™¤éæœ‰ç‰¹å®šåŸå› ï¼ŒReact **ä¸ä¼šä¸¢å¼ƒç¼“å­˜å€¼**ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼ŒReact ä¼šåœ¨ä½ ç¼–è¾‘ç»„ä»¶æ–‡ä»¶æ—¶ä¸¢å¼ƒç¼“å­˜ã€‚æ— è®ºæ˜¯åœ¨å¼€å‘ç¯å¢ƒè¿˜æ˜¯åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œå¦‚æœä½ çš„ç»„ä»¶åœ¨åˆå§‹æŒ‚è½½æœŸé—´è¢«ç»ˆæ­¢ï¼ŒReact éƒ½ä¼šä¸¢å¼ƒç¼“å­˜ã€‚åœ¨æœªæ¥ï¼ŒReact å¯èƒ½ä¼šæ·»åŠ æ›´å¤šåˆ©ç”¨ä¸¢å¼ƒç¼“å­˜çš„ç‰¹æ€§â€”â€”ä¾‹å¦‚ï¼Œå¦‚æœ React åœ¨æœªæ¥å¢åŠ äº†å¯¹è™šæ‹ŸåŒ–åˆ—è¡¨çš„å†…ç½®æ”¯æŒï¼Œé‚£ä¹ˆä¸¢å¼ƒé‚£äº›æ»šå‡ºè™šæ‹ŸåŒ–åˆ—è¡¨è§†å£çš„ç¼“å­˜æ˜¯æœ‰æ„ä¹‰çš„ã€‚ä½ å¯ä»¥ä»…ä»…ä¾èµ– `useMemo` ä½œä¸ºæ€§èƒ½ä¼˜åŒ–æ‰‹æ®µã€‚å¦åˆ™ï¼Œä½¿ç”¨ [state å˜é‡](https://zh-hans.react.dev/reference/react/useState#avoiding-recreating-the-initial-state) æˆ–è€… [ref](https://zh-hans.react.dev/reference/react/useRef#avoiding-recreating-the-ref-contents) å¯èƒ½æ›´åŠ åˆé€‚ã€‚

### ç”¨æ³•

#### è·³è¿‡ä»£ä»·æ˜‚è´µçš„é‡æ–°è®¡ç®—

ä½ éœ€è¦ç»™ `useMemo` ä¼ é€’ä¸¤æ ·ä¸œè¥¿ï¼š

1. ä¸€ä¸ªæ²¡æœ‰ä»»ä½•å‚æ•°çš„ calculation å‡½æ•°ï¼Œåƒè¿™æ · `() =>`ï¼Œå¹¶ä¸”è¿”å›ä»»ä½•ä½ æƒ³è¦çš„è®¡ç®—ç»“æœã€‚
2. ä¸€ä¸ªç”±åŒ…å«åœ¨ä½ çš„ç»„ä»¶ä¸­å¹¶åœ¨ calculation ä¸­ä½¿ç”¨çš„æ‰€æœ‰å€¼ç»„æˆçš„ä¾èµ–åˆ—è¡¨ã€‚

åœ¨åˆæ¬¡æ¸²æŸ“æ—¶ï¼ŒuseMemo æä¾›çš„å€¼å°†æ˜¯ calculation å‡½æ•°çš„æ‰§è¡Œç»“æœï¼›åœ¨åç»­æ¸²æŸ“æ—¶ï¼Œå¦‚æœä¾èµ–åˆ—è¡¨ä¸­çš„ä¾èµ–é¡¹æ²¡æœ‰å˜åŒ–ï¼ŒuseMemo å°†ä¼šè¿”å›ä¹‹å‰çš„è®¡ç®—ç»“æœã€‚å¦åˆ™ React ä¼šé‡æ–°è°ƒç”¨ calculation å‡½æ•°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„å€¼ã€‚

#### è·³è¿‡ç»„ä»¶çš„é‡æ–°æ¸²æŸ“

**é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼ŒReact ä¼šé€’å½’åœ°é‡æ–°æ¸²æŸ“å®ƒçš„æ‰€æœ‰å­ç»„ä»¶**ã€‚å¦‚æœä¸æƒ³è®©å­ç»„ä»¶åœ¨ props æœªå˜çš„æƒ…å†µä¸‹é‡æ–°æ¸²æŸ“ï¼Œå¯ä»¥ä½¿ç”¨`memo`å°†å…¶åŒ…è£¹ï¼Œå¹¶ç»“åˆ useMemo å¯¹ä¼ å…¥çš„å¯¹è±¡ç±»å‹ props è¿›è¡Œç¼“å­˜ã€‚

#### ç¼“å­˜ä¸€ä¸ªå¯¹è±¡æˆ–è€…å‡½æ•°

å¦‚æœæŸä¸ªè®¡ç®—é€šè¿‡ useMemo åŒ…è£…ï¼Œå¹¶ä¸”å®ƒçš„ä¾èµ–åˆ—è¡¨ä¸­çš„å¯¹è±¡æˆ–è€…å‡½æ•°æ˜¯åœ¨ç»„ä»¶ä¸»ä½“ä¸­åˆ›å»ºçš„ï¼Œè¯·æŠŠè¿™äº›å€¼ä¹Ÿé€šè¿‡ useMemo è¿›è¡ŒåŒ…è£…ï¼Œå¦åˆ™ç»„ä»¶æ¯æ¬¡æ¸²æŸ“ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡æˆ–è€…å‡½æ•°ï¼Œè§¦å‘æœ€å¼€å§‹çš„è®¡ç®—å‡½æ•°è¿›è¡Œé‡æ–°è®¡ç®—ï¼Œå¯¼è‡´ useMemo å¤±æ•ˆã€‚

```javascript
function Dropdown({ allItems, text }) {
    // const searchOptions = { matchMode: 'whole-word', text };
    // ç”¨ useMemo å°† searchOptions ä¹Ÿè¿›è¡ŒåŒ…è£¹
    const searchOptions = useMemo(() => {
        return { matchMode: 'whole-word', text };
    }, [text]); // âœ… åªæœ‰å½“ text æ”¹å˜æ—¶æ‰ä¼šå‘ç”Ÿæ”¹å˜

    const visibleItems = useMemo(() => {
        return searchItems(allItems, searchOptions);
    }, [allItems, searchOptions]); // âœ… åªæœ‰å½“ allItems æˆ– serachOptions æ”¹å˜æ—¶æ‰ä¼šå‘ç”Ÿæ”¹å˜
}
```

#### å¾ªç¯çš„åˆ—è¡¨é¡¹ä¸­ä½¿ç”¨ useMemo

```javascript
function ReportList({ items }) {
    return (
        <article>
            {items.map(item =>
                <Report key={item.id} item={item} />
            )}
        </article>
    );
}

function Report({ item }) {
    // âœ… åœ¨é¡¶å±‚è°ƒç”¨ useMemoï¼š
    const data = useMemo(() => calculateReport(item), [item]);
    return (
        <figure>
            <Chart data={data} />
        </figure>
    );
} 
```



## useCallback

### useCallback(fn, dependencies)

**å‚æ•°**

- `fn`ï¼šæƒ³è¦ç¼“å­˜çš„å‡½æ•°ã€‚æ­¤å‡½æ•°å¯ä»¥æ¥å—ä»»ä½•å‚æ•°å¹¶ä¸”è¿”å›ä»»ä½•å€¼ã€‚åœ¨åˆæ¬¡æ¸²æŸ“æ—¶ï¼ŒReact å°†æŠŠå‡½æ•°è¿”å›ç»™ä½ ï¼ˆè€Œä¸æ˜¯è°ƒç”¨å®ƒï¼ï¼‰ã€‚å½“è¿›è¡Œä¸‹ä¸€æ¬¡æ¸²æŸ“æ—¶ï¼Œå¦‚æœ `dependencies` ç›¸æ¯”äºä¸Šä¸€æ¬¡æ¸²æŸ“æ—¶æ²¡æœ‰æ”¹å˜ï¼Œé‚£ä¹ˆ React å°†ä¼šè¿”å›ç›¸åŒçš„å‡½æ•°ã€‚å¦åˆ™ï¼ŒReact å°†è¿”å›åœ¨æœ€æ–°ä¸€æ¬¡æ¸²æŸ“ä¸­ä¼ å…¥çš„å‡½æ•°ï¼Œå¹¶ä¸”å°†å…¶ç¼“å­˜ä»¥ä¾¿ä¹‹åä½¿ç”¨ã€‚React ä¸ä¼šè°ƒç”¨æ­¤å‡½æ•°ï¼Œè€Œæ˜¯è¿”å›æ­¤å‡½æ•°ã€‚ä½ å¯ä»¥è‡ªå·±å†³å®šä½•æ—¶è°ƒç”¨ä»¥åŠæ˜¯å¦è°ƒç”¨ã€‚
- `dependencies`ï¼šæœ‰å…³æ˜¯å¦æ›´æ–° `fn` çš„æ‰€æœ‰å“åº”å¼å€¼çš„ä¸€ä¸ªåˆ—è¡¨ã€‚å“åº”å¼å€¼åŒ…æ‹¬ propsã€stateï¼Œå’Œæ‰€æœ‰åœ¨ä½ ç»„ä»¶å†…éƒ¨ç›´æ¥å£°æ˜çš„å˜é‡å’Œå‡½æ•°ã€‚å¦‚æœä½ çš„ä»£ç æ£€æŸ¥å·¥å…· [é…ç½®äº† React](https://zh-hans.react.dev/learn/editor-setup#linting)ï¼Œé‚£ä¹ˆå®ƒå°†æ ¡éªŒæ¯ä¸€ä¸ªæ­£ç¡®æŒ‡å®šä¸ºä¾èµ–çš„å“åº”å¼å€¼ã€‚ä¾èµ–åˆ—è¡¨å¿…é¡»å…·æœ‰ç¡®åˆ‡æ•°é‡çš„é¡¹ï¼Œå¹¶ä¸”å¿…é¡»åƒ `[dep1, dep2, dep3]` è¿™æ ·ç¼–å†™ã€‚React ä½¿ç”¨ [`Object.is`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/is) æ¯”è¾ƒæ¯ä¸€ä¸ªä¾èµ–å’Œå®ƒçš„ä¹‹å‰çš„å€¼ã€‚

**è¿”å›**

åœ¨åˆæ¬¡æ¸²æŸ“æ—¶ï¼Œ`useCallback` è¿”å›ä½ å·²ç»ä¼ å…¥çš„ `fn` å‡½æ•°

åœ¨ä¹‹åçš„æ¸²æŸ“ä¸­, å¦‚æœä¾èµ–æ²¡æœ‰æ”¹å˜ï¼Œ`useCallback` è¿”å›ä¸Šä¸€æ¬¡æ¸²æŸ“ä¸­ç¼“å­˜çš„ `fn` å‡½æ•°ï¼›å¦åˆ™è¿”å›è¿™ä¸€æ¬¡æ¸²æŸ“ä¼ å…¥çš„ `fn`ã€‚

**æ³¨æ„äº‹é¡¹**

- `useCallback` æ˜¯ä¸€ä¸ª Hookï¼Œæ‰€ä»¥åº”è¯¥åœ¨ **ç»„ä»¶çš„é¡¶å±‚** æˆ–è‡ªå®šä¹‰ Hook ä¸­è°ƒç”¨ã€‚ä½ ä¸åº”åœ¨å¾ªç¯æˆ–è€…æ¡ä»¶è¯­å¥ä¸­è°ƒç”¨å®ƒã€‚å¦‚æœä½ éœ€è¦è¿™æ ·åšï¼Œè¯·æ–°å»ºä¸€ä¸ªç»„ä»¶ï¼Œå¹¶å°† state ç§»å…¥å…¶ä¸­ã€‚
- é™¤éæœ‰ç‰¹å®šçš„ç†ç”±ï¼ŒReact **å°†ä¸ä¼šä¸¢å¼ƒå·²ç¼“å­˜çš„å‡½æ•°**ã€‚ä¾‹å¦‚ï¼Œåœ¨å¼€å‘ä¸­ï¼Œå½“ç¼–è¾‘ç»„ä»¶æ–‡ä»¶æ—¶ï¼ŒReact ä¼šä¸¢å¼ƒç¼“å­˜ã€‚åœ¨ç”Ÿäº§å’Œå¼€å‘ç¯å¢ƒä¸­ï¼Œå¦‚æœä½ çš„ç»„ä»¶åœ¨åˆæ¬¡æŒ‚è½½ä¸­æš‚åœï¼ŒReact å°†ä¼šä¸¢å¼ƒç¼“å­˜ã€‚åœ¨æœªæ¥ï¼ŒReact å¯èƒ½ä¼šå¢åŠ æ›´å¤šåˆ©ç”¨äº†ä¸¢å¼ƒç¼“å­˜æœºåˆ¶çš„ç‰¹æ€§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ React æœªæ¥å†…ç½®äº†å¯¹è™šæ‹Ÿåˆ—è¡¨çš„æ”¯æŒï¼Œé‚£ä¹ˆåœ¨æ»šåŠ¨è¶…å‡ºè™šæ‹ŸåŒ–è¡¨è§†å£çš„é¡¹ç›®æ—¶ï¼ŒæŠ›å¼ƒç¼“å­˜æ˜¯æœ‰æ„ä¹‰çš„ã€‚å¦‚æœä½ ä¾èµ– `useCallback` ä½œä¸ºä¸€ä¸ªæ€§èƒ½ä¼˜åŒ–é€”å¾„ï¼Œé‚£ä¹ˆè¿™äº›å¯¹ä½ ä¼šæœ‰å¸®åŠ©ã€‚å¦åˆ™è¯·è€ƒè™‘ä½¿ç”¨ [state å˜é‡](https://zh-hans.react.dev/reference/react/useState#im-trying-to-set-state-to-a-function-but-it-gets-called-instead) æˆ– [ref](https://zh-hans.react.dev/reference/react/useRef#avoiding-recreating-the-ref-contents)ã€‚

### ç”¨æ³•

#### è·³è¿‡ç»„ä»¶çš„é‡æ–°æ¸²æŸ“

ä½ éœ€è¦ä¼ é€’ä¸¤ä¸ªå‚æ•°ç»™ `useCallback`ï¼š

1. åœ¨å¤šæ¬¡æ¸²æŸ“ä¸­éœ€è¦ç¼“å­˜çš„å‡½æ•°
2. å‡½æ•°å†…éƒ¨éœ€è¦ä½¿ç”¨åˆ°çš„æ‰€æœ‰ç»„ä»¶å†…éƒ¨å€¼çš„ä¾èµ–åˆ—è¡¨ã€‚

**é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ªç»„ä»¶é‡æ–°æ¸²æŸ“æ—¶ï¼Œ React å°†é€’å½’æ¸²æŸ“å®ƒçš„æ‰€æœ‰å­ç»„ä»¶**ã€‚å¦‚æœä¸æƒ³è®©å­ç»„ä»¶åœ¨ props æœªå˜çš„æƒ…å†µä¸‹é‡æ–°æ¸²æŸ“ï¼Œå¯ä»¥ä½¿ç”¨`memo`å°†å…¶åŒ…è£¹ï¼Œå¹¶ç»“åˆ useCallback å¯¹ä¼ å…¥çš„å‡½æ•°ç±»å‹ props è¿›è¡Œç¼“å­˜ã€‚

#### ä¼˜åŒ–è‡ªå®šä¹‰ Hook

å¦‚æœä½ æ­£åœ¨ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰ Hookï¼Œå»ºè®®å°†å®ƒè¿”å›çš„ä»»ä½•å‡½æ•°åŒ…è£¹åœ¨ `useCallback` ä¸­ï¼š

```javascript
function useRouter() {
    const { dispatch } = useContext(RouterStateContext);

    const navigate = useCallback((url) => {
        dispatch({ type: 'navigate', url });
    }, [dispatch]);

    const goBack = useCallback(() => {
        dispatch({ type: 'back' });
    }, [dispatch]);

    return {
        navigate,
        goBack,
    };
}
```

è¿™ç¡®ä¿äº† Hook çš„ä½¿ç”¨è€…åœ¨éœ€è¦æ—¶èƒ½å¤Ÿä¼˜åŒ–è‡ªå·±çš„ä»£ç ã€‚

#### å¾ªç¯çš„åˆ—è¡¨é¡¹ä¸­ä½¿ç”¨ useMemo

```javascript
function ReportList({ items }) {
    return (
        <article>
            {items.map(item =>
                <Report key={item.id} item={item} />
            )}
        </article>
    );
}

function Report({ item }) {
    // âœ… åœ¨æœ€é¡¶å±‚è°ƒç”¨ useCallback
    const handleClick = useCallback(() => {
        sendReport(item)
    }, [item]);

    return (
        <figure>
            <Chart onClick={handleClick} />
        </figure>
    );
}
```

